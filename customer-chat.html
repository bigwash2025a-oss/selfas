<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¬ ê¸°ì‚¬ë‹˜ê³¼ ì±„íŒ…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .header .status {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
            font-size: 0.85rem;
            margin-left: 10px;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }

        .message.customer {
            justify-content: flex-end;
        }

        .message.technician {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .message.customer .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.technician .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-sender {
            font-size: 0.75rem;
            margin-bottom: 4px;
            padding: 0 5px;
            color: #666;
        }

        .message-time {
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        .message-image {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 8px;
            cursor: pointer;
        }

        /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ */
        .system-message {
            text-align: center;
            margin: 20px 0;
            color: #999;
            font-size: 0.85rem;
        }

        .system-message-badge {
            background: #e0e0e0;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-input-label {
            cursor: pointer;
            font-size: 1.5rem;
            color: #667eea;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #f0f0f0;
        }

        #fileInput {
            display: none;
        }

        #messageInput {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        /* íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° */
        .file-preview {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .file-preview.active {
            display: flex;
        }

        .file-preview img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 5px;
        }

        .file-preview-info {
            flex: 1;
        }

        .file-preview-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* ë¡œë”© */
        .typing-indicator {
            display: none;
            padding: 10px;
            margin: 10px 0;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* ì™„ë£Œ í™•ì¸ ë²„íŠ¼ */
        .completion-area {
            background: #fff3cd;
            padding: 15px;
            text-align: center;
            border-top: 2px solid #ffc107;
            display: none;
        }

        .completion-area.active {
            display: block;
        }

        .completion-area button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
        }

        .completion-area button.secondary {
            background: #6c757d;
        }

        .completion-area button:hover {
            opacity: 0.9;
        }

        /* ì—ìŠ¤ì»¬ë ˆì´ì…˜ ë²„íŠ¼ ì˜ì—­ */
        .escalation-area {
            background: white;
            padding: 15px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .escalation-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .escalation-btn.phone {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .escalation-btn.phone:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .escalation-btn.visit {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .escalation-btn.visit:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .escalation-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>ğŸ’¬ ê¸°ì‚¬ë‹˜ê³¼ 1:1 ì±„íŒ…</h1>
                <div class="status">
                    <span id="statusText">ì—°ê²° ì¤‘...</span>
                    <span class="status-badge" id="statusBadge">ëŒ€ê¸°ì¤‘</span>
                </div>
            </div>
            <button onclick="exitChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                â† ë‚˜ê°€ê¸°
            </button>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="system-message">
            <div class="system-message-badge">
                ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤
            </div>
        </div>
    </div>

    <!-- ì—ìŠ¤ì»¬ë ˆì´ì…˜: ì „í™”/ì¶œë™ -->
    <div class="escalation-area" id="escalationArea">
        <button class="escalation-btn phone" onclick="callTechnician()">
            <span style="font-size: 1.5rem;">ğŸ“</span>
            <span>ì „í™” ìƒë‹´<br><small style="font-size: 0.85rem;">010-3004-8047</small></span>
        </button>
        <button class="escalation-btn visit" onclick="requestVisit()">
            <span style="font-size: 1.5rem;">ğŸš—</span>
            <span>ì¶œë™ ìš”ì²­<br><small style="font-size: 0.85rem;">ìµœí›„ ìˆ˜ë‹¨</small></span>
        </button>
    </div>

    <div class="completion-area" id="completionArea">
        <p style="margin-bottom: 10px; color: #856404;"><strong>ìˆ˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆë‚˜ìš”?</strong></p>
        <button onclick="confirmCompletion()">âœ… í™•ì¸ ì™„ë£Œ</button>
        <button class="secondary" onclick="reportIssue()">âš ï¸ ì¬ë¬¸ì œ ì‹ ê³ </button>
    </div>

    <div class="file-preview" id="filePreview">
        <img id="previewImage" src="" alt="Preview">
        <div class="file-preview-info">
            <div id="fileName"></div>
            <div style="font-size: 0.85rem; color: #666;" id="fileSize"></div>
        </div>
        <button class="file-preview-remove" onclick="cancelFile()">ì·¨ì†Œ</button>
    </div>

    <div class="input-area">
        <label for="fileInput" class="file-input-label">ğŸ“·</label>
        <input type="file" id="fileInput" accept="image/*,video/*" onchange="handleFileSelect(event)">

        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">

        <button class="send-button" onclick="sendMessage()">
            â¤
        </button>
    </div>

    <script>
        // ìë™ìœ¼ë¡œ ì„œë²„ ì£¼ì†Œ ê°ì§€ (ëª¨ë°”ì¼/PC ëª¨ë‘ ì§€ì›)
        const hostname = window.location.hostname || 'localhost';
        const API_URL = `http://${hostname}:53001/api`;
        const WS_URL = `ws://${hostname}:53001/ws`;

        const urlParams = new URLSearchParams(window.location.search);
        const requestId = urlParams.get('request_id');
        const customerName = urlParams.get('name') || 'ê³ ê°';

        let ws = null;
        let selectedFile = null;
        let currentRequest = null;

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            ws = new WebSocket(`${WS_URL}/${requestId}`);

            ws.onopen = () => {
                console.log('WebSocket ì—°ê²°ë¨');
                document.getElementById('statusText').textContent = 'ê¸°ì‚¬ë‹˜ ëŒ€ê¸° ì¤‘';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data);

                if (data.type === 'new_message') {
                    displayMessage(data.data);

                    // ìƒˆ ë©”ì‹œì§€ë¥¼ ë¡œì»¬ì— ì¶”ê°€ ì €ì¥
                    const localMessages = loadMessagesFromLocal();
                    const exists = localMessages.some(msg => msg.id === data.data.id);
                    if (!exists) {
                        localMessages.push(data.data);
                        saveMessagesToLocal(localMessages);
                        console.log('ğŸ’¾ ë©”ì‹œì§€ ë¡œì»¬ ì €ì¥ ì™„ë£Œ');
                    }
                } else if (data.type === 'request_updated') {
                    updateRequestStatus(data.data);
                } else if (data.type === 'schedule_proposed') {
                    // ìŠ¤ì¼€ì¤„ ì œì•ˆì´ ì™”ì„ ë•Œ
                    console.log('ğŸ“… ìŠ¤ì¼€ì¤„ ì œì•ˆ ìˆ˜ì‹ :', data.data);
                    loadMessages(); // ë©”ì‹œì§€ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ìŠ¤ì¼€ì¤„ ì œì•ˆ í‘œì‹œ
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket ì—ëŸ¬:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                setTimeout(connectWebSocket, 3000); // ì¬ì—°ê²° ì‹œë„
            };
        }

        // localStorage í‚¤
        const STORAGE_KEY = `chat_messages_${requestId}`;

        // ë©”ì‹œì§€ë¥¼ localStorageì— ì €ì¥
        function saveMessagesToLocal(messages) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
            } catch (e) {
                console.log('localStorage ì €ì¥ ì‹¤íŒ¨:', e);
            }
        }

        // localStorageì—ì„œ ë©”ì‹œì§€ ë¡œë“œ
        function loadMessagesFromLocal() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.log('localStorage ë¡œë“œ ì‹¤íŒ¨:', e);
                return [];
            }
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        async function loadInitialData() {
            try {
                // ë¨¼ì € ë¡œì»¬ ì €ì¥ëœ ë©”ì‹œì§€ ë¡œë“œ
                const localMessages = loadMessagesFromLocal();
                const displayedIds = new Set();

                if (localMessages.length > 0) {
                    console.log(`ğŸ“¦ ë¡œì»¬ì—ì„œ ${localMessages.length}ê°œ ë©”ì‹œì§€ ë³µì›`);
                    localMessages.forEach(msg => {
                        displayMessage(msg, false);
                        displayedIds.add(msg.id);
                    });
                }

                // ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`${API_URL}/as-requests/${requestId}`);
                currentRequest = await response.json();

                updateRequestStatus(currentRequest);

                // ì„œë²„ì˜ ìƒˆ ë©”ì‹œì§€ë§Œ ì¶”ê°€ í‘œì‹œ
                if (currentRequest.messages) {
                    const newMessages = currentRequest.messages.filter(msg => !displayedIds.has(msg.id));

                    if (newMessages.length > 0) {
                        console.log(`ğŸ†• ì„œë²„ì—ì„œ ${newMessages.length}ê°œ ìƒˆ ë©”ì‹œì§€ ë¡œë“œ`);
                        newMessages.forEach(msg => {
                            displayMessage(msg, false);
                        });
                    }

                    // ì „ì²´ ë©”ì‹œì§€ë¥¼ ë¡œì»¬ì— ì €ì¥
                    saveMessagesToLocal(currentRequest.messages);
                }

                scrollToBottom();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                console.log('ğŸ“¦ ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ì €ì¥ëœ ë©”ì‹œì§€ë§Œ í‘œì‹œ');
            }
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateRequestStatus(request) {
            currentRequest = request;
            const statusText = document.getElementById('statusText');
            const statusBadge = document.getElementById('statusBadge');

            const statusMap = {
                'pending': { text: 'ê¸°ì‚¬ë‹˜ ë°°ì • ëŒ€ê¸° ì¤‘', badge: 'ëŒ€ê¸°ì¤‘', color: '#ffc107' },
                'assigned': { text: 'ê¸°ì‚¬ë‹˜ì´ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤', badge: 'ë°°ì •ë¨', color: '#17a2b8' },
                'in_progress': { text: 'ìˆ˜ë¦¬ ì§„í–‰ ì¤‘', badge: 'ì§„í–‰ì¤‘', color: '#007bff' },
                'needs_visit': { text: 'ğŸš— ê¸°ì‚¬ë‹˜ ì¶œë™ ì¤‘', badge: 'ì¶œë™ì¤‘', color: '#e74c3c' },
                'completed': { text: 'ìˆ˜ë¦¬ ì™„ë£Œ', badge: 'ì™„ë£Œ', color: '#28a745' },
                'confirmed': { text: 'í™•ì¸ ì™„ë£Œ', badge: 'í™•ì¸ë¨', color: '#6c757d' }
            };

            const status = statusMap[request.status] || statusMap['pending'];
            statusText.textContent = status.text;
            statusBadge.textContent = status.badge;
            statusBadge.style.background = status.color;

            // ìˆ˜ë¦¬ ì™„ë£Œ ì‹œ í™•ì¸ ë²„íŠ¼ í‘œì‹œ
            if (request.status === 'completed') {
                document.getElementById('completionArea').classList.add('active');
            } else {
                document.getElementById('completionArea').classList.remove('active');
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function displayMessage(message, animate = true) {
            const chatContainer = document.getElementById('chatContainer');

            // ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
            if (document.querySelector(`[data-message-id="${message.id}"]`)) {
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender_type}`;
            messageDiv.setAttribute('data-message-id', message.id);

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';

            // ë°œì‹ ì ì´ë¦„
            if (message.sender_type === 'technician') {
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = message.sender_name;
                messageDiv.appendChild(senderDiv);
            }

            // ë©”ì‹œì§€ ë‚´ìš©
            if (message.message_type === 'image' && message.file_url) {
                const img = document.createElement('img');
                img.src = `http://${hostname}:53001${message.file_url}`;
                img.className = 'message-image';
                img.onclick = () => window.open(img.src, '_blank');
                bubbleDiv.appendChild(img);

                if (message.content) {
                    const textDiv = document.createElement('div');
                    textDiv.textContent = message.content;
                    bubbleDiv.appendChild(textDiv);
                }
            } else {
                // ìŠ¤ì¼€ì¤„ ì œì•ˆ ë©”ì‹œì§€ ê°ì§€
                if (message.sender_type === 'technician' && message.content.includes('ğŸ“… ì¶œë™ ì‹œê°„ ì œì•ˆë“œë¦½ë‹ˆë‹¤')) {
                    // ìŠ¤ì¼€ì¤„ ì œì•ˆ ì¹´ë“œ UI
                    bubbleDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    bubbleDiv.style.color = 'white';
                    bubbleDiv.style.padding = '20px';
                    bubbleDiv.style.borderRadius = '15px';
                    bubbleDiv.innerHTML = message.content.replace(/\n/g, '<br>');

                    // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (3ê°œ: ìˆ˜ë½, ë³€ê²½ìš”ì²­, ê±°ì ˆ)
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.marginTop = '15px';
                    buttonContainer.style.display = 'grid';
                    buttonContainer.style.gridTemplateColumns = '1fr 1fr';
                    buttonContainer.style.gap = '10px';

                    const acceptBtn = document.createElement('button');
                    acceptBtn.innerHTML = 'âœ… ìˆ˜ë½';
                    acceptBtn.style.gridColumn = '1 / -1';
                    acceptBtn.style.padding = '15px';
                    acceptBtn.style.background = '#27ae60';
                    acceptBtn.style.color = 'white';
                    acceptBtn.style.border = 'none';
                    acceptBtn.style.borderRadius = '10px';
                    acceptBtn.style.fontWeight = 'bold';
                    acceptBtn.style.fontSize = '1.05rem';
                    acceptBtn.style.cursor = 'pointer';
                    acceptBtn.style.transition = 'all 0.2s';
                    acceptBtn.onmouseover = () => acceptBtn.style.background = '#229954';
                    acceptBtn.onmouseout = () => acceptBtn.style.background = '#27ae60';
                    acceptBtn.onclick = () => acceptSchedule(message.id);

                    const changeBtn = document.createElement('button');
                    changeBtn.innerHTML = 'ğŸ”„ ë³€ê²½ìš”ì²­';
                    changeBtn.style.padding = '12px';
                    changeBtn.style.background = '#f39c12';
                    changeBtn.style.color = 'white';
                    changeBtn.style.border = 'none';
                    changeBtn.style.borderRadius = '10px';
                    changeBtn.style.fontWeight = 'bold';
                    changeBtn.style.cursor = 'pointer';
                    changeBtn.style.transition = 'all 0.2s';
                    changeBtn.onmouseover = () => changeBtn.style.background = '#d68910';
                    changeBtn.onmouseout = () => changeBtn.style.background = '#f39c12';
                    changeBtn.onclick = () => requestScheduleChange(message.id);

                    const rejectBtn = document.createElement('button');
                    rejectBtn.innerHTML = 'âŒ ê±°ì ˆ';
                    rejectBtn.style.padding = '12px';
                    rejectBtn.style.background = '#95a5a6';
                    rejectBtn.style.color = 'white';
                    rejectBtn.style.border = 'none';
                    rejectBtn.style.borderRadius = '10px';
                    rejectBtn.style.fontWeight = 'bold';
                    rejectBtn.style.cursor = 'pointer';
                    rejectBtn.style.transition = 'all 0.2s';
                    rejectBtn.onmouseover = () => rejectBtn.style.background = '#7f8c8d';
                    rejectBtn.onmouseout = () => rejectBtn.style.background = '#95a5a6';
                    rejectBtn.onclick = () => rejectSchedule(message.id);

                    buttonContainer.appendChild(acceptBtn);
                    buttonContainer.appendChild(changeBtn);
                    buttonContainer.appendChild(rejectBtn);
                    bubbleDiv.appendChild(buttonContainer);
                } else {
                    bubbleDiv.textContent = message.content;
                }
            }

            // ì‹œê°„
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            const time = new Date(message.created_at);
            timeDiv.textContent = time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            bubbleDiv.appendChild(timeDiv);

            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);

            if (animate) {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    messageDiv.style.transition = 'all 0.3s';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                }, 10);
            }

            scrollToBottom();
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message && !selectedFile) return;

            let fileUrl = null;

            // íŒŒì¼ ì—…ë¡œë“œ
            if (selectedFile) {
                try {
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('request_id', requestId);
                    formData.append('uploaded_by', customerName);

                    const response = await fetch(`${API_URL}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    fileUrl = data.file_url;
                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            // ë©”ì‹œì§€ ì „ì†¡
            try {
                const response = await fetch(`${API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        sender_type: 'customer',
                        sender_name: customerName,
                        message_type: fileUrl ? 'image' : 'text',
                        content: message || 'ì‚¬ì§„',
                        file_url: fileUrl
                    })
                });

                const newMessage = await response.json();

                // ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ë¡œì»¬ì— ì €ì¥
                const localMessages = loadMessagesFromLocal();
                localMessages.push(newMessage);
                saveMessagesToLocal(localMessages);
                console.log('ğŸ’¾ ë‚´ ë©”ì‹œì§€ ë¡œì»¬ ì €ì¥ ì™„ë£Œ');

                input.value = '';
                cancelFile();

            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
            }
        }

        // íŒŒì¼ ì„ íƒ
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            selectedFile = file;

            // ë¯¸ë¦¬ë³´ê¸°
            const preview = document.getElementById('filePreview');
            const previewImage = document.getElementById('previewImage');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            preview.classList.add('active');
        }

        function cancelFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').classList.remove('active');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ì—”í„°í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ìŠ¤í¬ë¡¤
        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        // ì™„ë£Œ í™•ì¸
        async function confirmCompletion() {
            if (!confirm('ìˆ˜ë¦¬ê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆë‚˜ìš”?')) return;

            try {
                await fetch(`${API_URL}/as-requests/${requestId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'confirmed'
                    })
                });

                alert('ê°ì‚¬í•©ë‹ˆë‹¤! í¬ì¸íŠ¸ 1,000ì›ì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰');
                document.getElementById('completionArea').classList.remove('active');

            } catch (error) {
                console.error('ì™„ë£Œ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        // ì¬ë¬¸ì œ ì‹ ê³ 
        async function reportIssue() {
            const issue = prompt('ì–´ë–¤ ë¬¸ì œê°€ ìˆë‚˜ìš”?');
            if (!issue) return;

            try {
                await fetch(`${API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        sender_type: 'customer',
                        sender_name: customerName,
                        message_type: 'text',
                        content: `âš ï¸ ì¬ë¬¸ì œ ì‹ ê³ : ${issue}`
                    })
                });

                await fetch(`${API_URL}/as-requests/${requestId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'in_progress'
                    })
                });

            } catch (error) {
                console.error('ì¬ë¬¸ì œ ì‹ ê³  ì‹¤íŒ¨:', error);
            }
        }

        // ì „í™” ìƒë‹´ (ì—ìŠ¤ì»¬ë ˆì´ì…˜ 2ë‹¨ê³„)
        function callTechnician() {
            if (confirm('ê¸°ì‚¬ë‹˜ê³¼ ì§ì ‘ í†µí™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n010-3004-8047ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.')) {
                // ì±„íŒ…ì— ì „í™” ì‹œë„ ê¸°ë¡
                fetch(`${API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        sender_type: 'customer',
                        sender_name: customerName,
                        message_type: 'text',
                        content: 'ğŸ“ ê³ ê°ë‹˜ì´ ì „í™” ìƒë‹´ì„ ìš”ì²­í•˜ì…¨ìŠµë‹ˆë‹¤.'
                    })
                });

                // ì „í™” ì—°ê²°
                window.location.href = 'tel:010-3004-8047';
            }
        }

        // ì¶œë™ ìš”ì²­ (ì—ìŠ¤ì»¬ë ˆì´ì…˜ 3ë‹¨ê³„)
        async function requestVisit() {
            if (!confirm('ì¶œë™ ì„œë¹„ìŠ¤ë¥¼ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì‚¬ë‹˜ì´ í˜„ì¥ìœ¼ë¡œ ë°©ë¬¸í•©ë‹ˆë‹¤.\nì¶”ê°€ ë¹„ìš©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                // ìƒíƒœë¥¼ needs_visitìœ¼ë¡œ ë³€ê²½
                await fetch(`${API_URL}/as-requests/${requestId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'needs_visit',
                        priority: 'urgent'
                    })
                });

                // ì±„íŒ…ì— ì¶œë™ ìš”ì²­ ê¸°ë¡
                await fetch(`${API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        sender_type: 'customer',
                        sender_name: customerName,
                        message_type: 'text',
                        content: 'ğŸš— ê³ ê°ë‹˜ì´ ì¶œë™ ì„œë¹„ìŠ¤ë¥¼ ìš”ì²­í•˜ì…¨ìŠµë‹ˆë‹¤. (ê¸´ê¸‰)'
                    })
                });

                alert('âœ… ì¶œë™ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nê¸°ì‚¬ë‹˜ì´ ê³§ ë°©ë¬¸ ì¼ì •ì„ ì œì•ˆí•  ì˜ˆì •ì…ë‹ˆë‹¤.\nì œì•ˆì„ ë°›ìœ¼ì‹œë©´ ìˆ˜ë½/ê±°ì ˆ ë²„íŠ¼ì´ í‘œì‹œë©ë‹ˆë‹¤.');

            } catch (error) {
                console.error('ì¶œë™ ìš”ì²­ ì‹¤íŒ¨:', error);
                alert('ì¶œë™ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ë‚˜ê°€ê¸° ë²„íŠ¼
        function exitChat() {
            if (confirm('ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\në©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')) {
                // WebSocket ì—°ê²° ì¢…ë£Œ
                if (ws) {
                    ws.close();
                }
                // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'index.html';
            }
        }

        // ==================== ìŠ¤ì¼€ì¤„ ìˆ˜ë½/ê±°ì ˆ ====================

        // ìŠ¤ì¼€ì¤„ ìˆ˜ë½
        async function acceptSchedule(messageId) {
            try {
                // í˜„ì¬ ìš”ì²­ì˜ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
                const schedulesResponse = await fetch(`${API_URL}/visit-schedules/${requestId}`);
                const schedules = await schedulesResponse.json();

                // ê°€ì¥ ìµœê·¼ ì œì•ˆëœ ìŠ¤ì¼€ì¤„ ì°¾ê¸°
                const latestSchedule = schedules.find(s => s.status === 'proposed');

                if (!latestSchedule) {
                    alert('ìŠ¤ì¼€ì¤„ ì œì•ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ìŠ¤ì¼€ì¤„ ìˆ˜ë½ ì²˜ë¦¬
                await fetch(`${API_URL}/visit-schedules/${latestSchedule.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'accepted' })
                });

                // ìˆ˜ë½ ë©”ì‹œì§€ ì „ì†¡
                await fetch(`${API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_id: requestId,
                        sender_type: 'customer',
                        sender_name: customerName,
                        message_type: 'text',
                        content: 'âœ… ì œì•ˆí•˜ì‹  ì‹œê°„ì— ë°©ë¬¸ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!'
                    })
                });

                alert('âœ… ìŠ¤ì¼€ì¤„ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\nê¸°ì‚¬ë‹˜ì´ ì•½ì†ëœ ì‹œê°„ì— ë°©ë¬¸í•©ë‹ˆë‹¤.');
                loadMessages(); // ë©”ì‹œì§€ ë‹¤ì‹œ ë¡œë“œ

            } catch (error) {
                console.error('ìŠ¤ì¼€ì¤„ ìˆ˜ë½ ì‹¤íŒ¨:', error);
                alert('ìŠ¤ì¼€ì¤„ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìŠ¤ì¼€ì¤„ ë³€ê²½ ìš”ì²­ (ìƒˆë¡œ ì¶”ê°€)
        async function requestScheduleChange(messageId) {
            // ë‚ ì§œ/ì‹œê°„ ì„ íƒ ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '10000';

            const modalContent = document.createElement('div');
            modalContent.style.background = 'white';
            modalContent.style.padding = '30px';
            modalContent.style.borderRadius = '20px';
            modalContent.style.maxWidth = '400px';
            modalContent.style.width = '90%';
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ”„ í¬ë§ ë‚ ì§œ/ì‹œê°„ ì„ íƒ</h3>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">ë‚ ì§œ</label>
                    <input type="date" id="changeDate" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;" min="${new Date().toISOString().split('T')[0]}">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">ì‹œê°„</label>
                    <select id="changeTime" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        <option value="09:00">ì˜¤ì „ 9ì‹œ</option>
                        <option value="10:00">ì˜¤ì „ 10ì‹œ</option>
                        <option value="11:00">ì˜¤ì „ 11ì‹œ</option>
                        <option value="12:00">ë‚® 12ì‹œ</option>
                        <option value="13:00">ì˜¤í›„ 1ì‹œ</option>
                        <option value="14:00">ì˜¤í›„ 2ì‹œ</option>
                        <option value="15:00">ì˜¤í›„ 3ì‹œ</option>
                        <option value="16:00">ì˜¤í›„ 4ì‹œ</option>
                        <option value="17:00">ì˜¤í›„ 5ì‹œ</option>
                        <option value="18:00">ì˜¤í›„ 6ì‹œ</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">ì¶”ê°€ ìš”ì²­ì‚¬í•­ (ì„ íƒ)</label>
                    <textarea id="changeNote" placeholder="ì˜ˆ: ì ì‹¬ì‹œê°„ í”¼í•´ì£¼ì„¸ìš”" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem; resize: vertical; min-height: 60px;"></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="confirmChange" style="flex: 1; padding: 15px; background: #f39c12; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer;">í™•ì¸</button>
                    <button id="cancelChange" style="flex: 1; padding: 15px; background: #95a5a6; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer;">ì·¨ì†Œ</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('changeDate').value = tomorrow.toISOString().split('T')[0];

            // í™•ì¸ ë²„íŠ¼
            document.getElementById('confirmChange').onclick = async () => {
                const date = document.getElementById('changeDate').value;
                const time = document.getElementById('changeTime').value;
                const note = document.getElementById('changeNote').value;

                if (!date) {
                    alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    // í˜„ì¬ ìš”ì²­ì˜ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
                    const schedulesResponse = await fetch(`${API_URL}/visit-schedules/${requestId}`);
                    const schedules = await schedulesResponse.json();
                    const latestSchedule = schedules.find(s => s.status === 'proposed');

                    if (latestSchedule) {
                        // ìŠ¤ì¼€ì¤„ ê±°ì ˆ ì²˜ë¦¬
                        await fetch(`${API_URL}/visit-schedules/${latestSchedule.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'rejected' })
                        });
                    }

                    // ë³€ê²½ ìš”ì²­ ë©”ì‹œì§€ ì „ì†¡
                    const formattedDate = new Date(date).toLocaleDateString('ko-KR', {
                        month: 'long',
                        day: 'numeric',
                        weekday: 'short'
                    });

                    const formattedTime = time.replace(/(\d{2}):(\d{2})/, (_, h, m) => {
                        const hour = parseInt(h);
                        const period = hour < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
                        const displayHour = hour > 12 ? hour - 12 : hour;
                        return `${period} ${displayHour}ì‹œ`;
                    });

                    let content = `ğŸ”„ ë‹¤ë¥¸ ì‹œê°„ì„ í¬ë§í•©ë‹ˆë‹¤.\n\nğŸ“… í¬ë§ ì¼ì‹œ: ${formattedDate} ${formattedTime}`;
                    if (note) {
                        content += `\nğŸ“ ìš”ì²­ì‚¬í•­: ${note}`;
                    }

                    await fetch(`${API_URL}/chat-messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            request_id: requestId,
                            sender_type: 'customer',
                            sender_name: customerName,
                            message_type: 'text',
                            content: content
                        })
                    });

                    modal.remove();
                    alert('âœ… ë³€ê²½ ìš”ì²­ì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nê¸°ì‚¬ë‹˜ì´ í™•ì¸ í›„ ë‹¤ì‹œ ì œì•ˆë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.');
                    loadMessages();

                } catch (error) {
                    console.error('ìŠ¤ì¼€ì¤„ ë³€ê²½ ìš”ì²­ ì‹¤íŒ¨:', error);
                    alert('ë³€ê²½ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };

            // ì·¨ì†Œ ë²„íŠ¼
            document.getElementById('cancelChange').onclick = () => {
                modal.remove();
            };

            // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // ìŠ¤ì¼€ì¤„ ê±°ì ˆ
        async function rejectSchedule(messageId) {
            if (!confirm('ì¶œë™ ìì²´ë¥¼ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‹¤ë¥¸ ì‹œê°„ì„ ì›í•˜ì‹œë©´ "ë³€ê²½ìš”ì²­" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.')) {
                return;
            }

            try {
                // í˜„ì¬ ìš”ì²­ì˜ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
                const schedulesResponse = await fetch(`${API_URL}/visit-schedules/${requestId}`);
                const schedules = await schedulesResponse.json();
                const latestSchedule = schedules.find(s => s.status === 'proposed');

                if (latestSchedule) {
                    // ìŠ¤ì¼€ì¤„ ê±°ì ˆ ì²˜ë¦¬
                    await fetch(`${API_URL}/visit-schedules/${latestSchedule.id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'rejected' })
                    });
                }

                // ê±°ì ˆ ë©”ì‹œì§€ ì „ì†¡
                await fetch(`${API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_id: requestId,
                        sender_type: 'customer',
                        sender_name: customerName,
                        message_type: 'text',
                        content: `âŒ ì¶œë™ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤. ê±°ì ˆí•©ë‹ˆë‹¤.`
                    })
                });

                alert('ê±°ì ˆ ì˜ì‚¬ê°€ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadMessages();

            } catch (error) {
                console.error('ìŠ¤ì¼€ì¤„ ê±°ì ˆ ì‹¤íŒ¨:', error);
                alert('ìŠ¤ì¼€ì¤„ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ˆê¸°í™”
        connectWebSocket();
        loadInitialData();
    </script>

    <!-- ğŸ”§ ì±„íŒ… ìœ„ì ¯ ë¡œë“œ (ë¯¸ë‹ˆ ë²„ì „) - ì±„íŒ…ë°©ì—ì„œëŠ” ìˆ¨ê¹€ -->
    <script>
    fetch('chat-widget.html')
        .then(response => response.text())
        .then(html => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // ìŠ¤íƒ€ì¼ ì¶”ê°€
            const styles = tempDiv.querySelectorAll('style');
            styles.forEach(style => document.head.appendChild(style.cloneNode(true)));

            // ìµœìƒìœ„ ìš”ì†Œë§Œ ì¶”ê°€ (ì¤‘ì²©ëœ ìì‹ê¹Œì§€ ìë™ í¬í•¨)
            Array.from(tempDiv.children).forEach(child => {
                if (child.tagName === 'BUTTON' || child.tagName === 'DIV') {
                    document.body.appendChild(child.cloneNode(true));
                }
            });

            // ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ (ìƒˆë¡œ ìƒì„±í•´ì„œ ì‹¤í–‰)
            const scripts = tempDiv.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;
                document.body.appendChild(newScript);
            });

            // ìœ„ì ¯ ì´ˆê¸°í™” ë° í”Œë¡œíŒ… ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì±„íŒ…ë°©ì—ì„œëŠ” ë¶ˆí•„ìš”)
            setTimeout(() => {
                if (window.chatWidget) {
                    window.chatWidget.init();
                }
                const btn = document.getElementById('chatFloatingBtn');
                if (btn) {
                    btn.style.display = 'none'; // ì±„íŒ…ë°©ì—ì„œëŠ” í”Œë¡œíŒ… ë²„íŠ¼ ìˆ¨ê¹€
                }
            }, 200);
        })
        .catch(err => console.log('ì±„íŒ… ìœ„ì ¯ ë¡œë“œ ì‹¤íŒ¨:', err));
    </script>
</body>
</html>
