<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ê¸°ì‚¬ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.8rem;
        }

        .technician-name {
            font-size: 1rem;
            opacity: 0.9;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* íƒ­ */
        .tabs {
            background: white;
            display: flex;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            background: #f8f9fa;
        }

        .tab-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 5px;
        }

        /* ì»¨í…ì¸  */
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* AS ìš”ì²­ ì¹´ë“œ */
        .request-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 5px solid #3498db;
            transition: all 0.3s;
            cursor: pointer;
        }

        .request-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .request-card.priority-high {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .request-card.priority-urgent {
            border-left-color: #c0392b;
            background: #ffe6e6;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.95; }
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .request-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .request-time {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .request-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-status {
            background: #3498db;
            color: white;
        }

        .badge-priority {
            background: #f39c12;
            color: white;
        }

        .badge-urgent {
            background: #e74c3c;
            color: white;
        }

        .request-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-icon {
            font-size: 1.2rem;
        }

        .info-label {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .info-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-section {
            display: none;
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            z-index: 1000;
            flex-direction: column;
        }

        .chat-section.active {
            display: flex;
        }

        .chat-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.customer {
            align-items: flex-end;
        }

        .chat-message.technician {
            align-items: flex-start;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .chat-message.customer .chat-bubble {
            background: #e8f5e9;
            color: #1b5e20;
        }

        .chat-message.technician .chat-bubble {
            background: #2c3e50;
            color: white;
        }

        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
        }

        .chat-send {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        /* ëª¨ë°”ì¼ */
        @media (max-width: 768px) {
            .chat-section {
                width: 100%;
            }

            .request-info {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                justify-content: space-around;
            }
        }

        /* ì•Œë¦¼ìŒ ì• ë‹ˆë©”ì´ì…˜ */
        .new-request-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.5);
            z-index: 2000;
            animation: slideIn 0.5s, fadeOut 0.5s 3.5s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(400px); }
        }

        /* ìŠ¤ì¼€ì¤„ ëª¨ë‹¬ */
        .schedule-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .schedule-modal.active {
            display: flex;
        }

        .schedule-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .schedule-modal h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div>
                <h1>ğŸ”§ ê¸°ì‚¬ ëŒ€ì‹œë³´ë“œ</h1>
                <div class="technician-name">ë°•ê¸°ì‚¬ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.9rem;">ì˜¤ëŠ˜</div>
                <div id="currentTime" style="font-size: 1.2rem; font-weight: bold;"></div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="todayRequests">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ìš”ì²­</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="pendingRequests">0</div>
                <div class="stat-label">ëŒ€ê¸°ì¤‘</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completedToday">0</div>
                <div class="stat-label">ì™„ë£Œ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgResponseTime">-</div>
                <div class="stat-label">í‰ê·  ì‘ë‹µì‹œê°„</div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('pending')">
            ëŒ€ê¸°ì¤‘ <span class="tab-badge" id="pendingBadge">0</span>
        </div>
        <div class="tab" onclick="switchTab('needs_visit')">
            ğŸš— ì¶œë™ ìš”ì²­ <span class="tab-badge" id="needsVisitBadge" style="background: #e74c3c;">0</span>
        </div>
        <div class="tab" onclick="switchTab('in_progress')">
            ì§„í–‰ì¤‘ <span class="tab-badge" id="inProgressBadge" style="background: #3498db;">0</span>
        </div>
        <div class="tab" onclick="switchTab('completed')">
            ì™„ë£Œ <span class="tab-badge" id="completedBadge" style="background: #27ae60;">0</span>
        </div>
        <div class="tab" onclick="switchTab('all')">
            ì „ì²´
        </div>
        <div class="tab" onclick="switchTab('logs')">
            ğŸ“Š ë¡œê·¸ ë¶„ì„
        </div>
    </div>

    <div class="content">
        <div id="pending" class="tab-content active">
            <!-- ëŒ€ê¸°ì¤‘ ìš”ì²­ -->
        </div>
        <div id="needs_visit" class="tab-content">
            <!-- ì¶œë™ ìš”ì²­ -->
        </div>
        <div id="in_progress" class="tab-content">
            <!-- ì§„í–‰ì¤‘ ìš”ì²­ -->
        </div>
        <div id="completed" class="tab-content">
            <!-- ì™„ë£Œ ìš”ì²­ -->
        </div>
        <div id="all" class="tab-content">
            <!-- ì „ì²´ ìš”ì²­ -->
        </div>
        <div id="logs" class="tab-content">
            <!-- ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ë¡œê·¸ -->
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #2c3e50;">ğŸ“Š ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ë¡œê·¸</h2>
                    <div style="display: flex; gap: 10px;">
                        <span id="logCount" style="background: #3498db; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold;">-</span>
                        <button onclick="loadLogs()" class="btn btn-primary" style="padding: 8px 15px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <!-- ê²€ìƒ‰ ë° í•„í„° -->
                <div class="request-card" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="logSearchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (IP, ê³ ê°ëª…, ì „í™”ë²ˆí˜¸ ë“±)" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;" onkeypress="if(event.key==='Enter') searchLogs()">
                        <button onclick="searchLogs()" class="btn btn-primary">ğŸ” ê²€ìƒ‰</button>
                        <button onclick="clearSearch()" class="btn btn-secondary">âœ• ì´ˆê¸°í™”</button>
                        <select id="logLinesSelect" onchange="loadLogs()" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="50">50ì¤„</option>
                            <option value="100" selected>100ì¤„</option>
                            <option value="200">200ì¤„</option>
                            <option value="500">500ì¤„</option>
                        </select>
                    </div>
                </div>

                <!-- ë¡œê·¸ ì¶œë ¥ ì˜ì—­ -->
                <div class="request-card" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #d4d4d4; padding: 20px; border-radius: 15px; max-height: 700px; overflow-y: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);">
                    <div id="logOutput" style="min-height: 100px;">
                        <div style="text-align: center; padding: 40px; color: #95a5a6;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“Š</div>
                            ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>

                <!-- ìë™ ìƒˆë¡œê³ ì¹¨ -->
                <div style="margin-top: 15px; text-align: center;">
                    <label style="cursor: pointer;">
                        <input type="checkbox" id="autoRefreshCheckbox" onchange="toggleAutoRefresh()" checked>
                        <span style="margin-left: 5px; color: #7f8c8d;">5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¤ì¼€ì¤„ ì œì•ˆ ëª¨ë‹¬ -->
    <div class="schedule-modal" id="scheduleModal">
        <div class="schedule-modal-content">
            <h2>ğŸ“… ì¶œë™ ì‹œê°„ ì œì•ˆ</h2>

            <div class="form-group">
                <label>ë‚ ì§œ</label>
                <input type="date" id="scheduleDate" required>
            </div>

            <div class="form-group">
                <label>ì‹œê°„</label>
                <input type="time" id="scheduleTime" required>
            </div>

            <div class="form-group">
                <label>ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                <textarea id="scheduleNotes" rows="3" placeholder="ì˜ˆ: ë¶€í’ˆ ì¤€ë¹„ í•„ìš”, ì˜ˆìƒ ì‘ì—… ì‹œê°„ 1ì‹œê°„"></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeScheduleModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="submitVisitSchedule()">ì œì•ˆ ì „ì†¡</button>
            </div>
        </div>
    </div>

    <!-- ì±„íŒ… ì‚¬ì´ë“œë°” -->
    <div class="chat-section" id="chatSection">
        <div class="chat-header">
            <div>
                <div style="font-size: 1.2rem; font-weight: bold;" id="chatCustomerName">ê³ ê°</div>
                <div style="font-size: 0.85rem; opacity: 0.9;" id="chatRequestInfo">-</div>
            </div>
            <button class="chat-close" onclick="closeChat()">âœ•</button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- ì±„íŒ… ë©”ì‹œì§€ -->
        </div>

        <div class="chat-input-area">
            <label for="techFileInput" style="cursor: pointer; font-size: 1.5rem;">ğŸ“·</label>
            <input type="file" id="techFileInput" style="display: none;" accept="image/*" onchange="handleTechFileSelect(event)">

            <input type="text" class="chat-input" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleChatKeyPress(event)">

            <button class="chat-send" onclick="sendTechMessage()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // ìë™ìœ¼ë¡œ ì„œë²„ ì£¼ì†Œ ê°ì§€ (ëª¨ë°”ì¼/PC ëª¨ë‘ ì§€ì›)
        const hostname = window.location.hostname || 'localhost';
        const API_URL = `http://${hostname}:53001/api`;
        const WS_URL = `ws://${hostname}:53001/ws`;

        const technicianName = 'ë°•ê¸°ì‚¬';
        let requests = [];
        let currentChatRequest = null;
        let chatWs = null;
        let selectedTechFile = null;

        // ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ko-KR');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ìš”ì²­ ë¡œë“œ
        async function loadRequests() {
            try {
                const response = await fetch(`${API_URL}/as-requests`);
                requests = await response.json();
                renderRequests();
                updateStats();
            } catch (error) {
                console.error('ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        async function updateStats() {
            try {
                const response = await fetch(`${API_URL}/statistics/dashboard`);
                const stats = await response.json();

                document.getElementById('todayRequests').textContent = stats.today_requests;
                document.getElementById('pendingRequests').textContent = stats.status_counts.pending || 0;
                document.getElementById('completedToday').textContent = stats.status_counts.completed || 0;
                document.getElementById('avgResponseTime').textContent = stats.avg_response_time_minutes + 'ë¶„';

                // ë°°ì§€ ì—…ë°ì´íŠ¸
                document.getElementById('pendingBadge').textContent = stats.status_counts.pending || 0;
                document.getElementById('needsVisitBadge').textContent = stats.status_counts.needs_visit || 0;
                document.getElementById('inProgressBadge').textContent = stats.status_counts.in_progress || 0;
                document.getElementById('completedBadge').textContent = stats.status_counts.completed || 0;

            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìš”ì²­ ë Œë”ë§
        function renderRequests() {
            const tabs = ['pending', 'needs_visit', 'in_progress', 'completed', 'all'];

            tabs.forEach(tab => {
                const container = document.getElementById(tab);
                container.innerHTML = '';

                const filteredRequests = tab === 'all' ? requests : requests.filter(r => r.status === tab);

                if (filteredRequests.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div>${tab === 'needs_visit' ? 'ğŸš— ì¶œë™ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤' : 'ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤'}</div>
                        </div>
                    `;
                    return;
                }

                // ì¶œë™ ìš”ì²­ íƒ­ì€ ê¸´ê¸‰ ìš°ì„ ìˆœìœ„ë¡œ ì •ë ¬
                const sortedRequests = tab === 'needs_visit'
                    ? filteredRequests.sort((a, b) => {
                        if (a.priority === 'urgent' && b.priority !== 'urgent') return -1;
                        if (a.priority !== 'urgent' && b.priority === 'urgent') return 1;
                        return new Date(b.created_at) - new Date(a.created_at);
                    })
                    : filteredRequests;

                sortedRequests.forEach(request => {
                    container.appendChild(createRequestCard(request));
                });
            });
        }

        // ìš”ì²­ ì¹´ë“œ ìƒì„±
        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'request-card';
            if (request.priority === 'high') card.classList.add('priority-high');
            if (request.priority === 'urgent') card.classList.add('priority-urgent');

            const timeAgo = getTimeAgo(new Date(request.created_at));
            const statusText = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'assigned': 'ë°°ì •ë¨',
                'in_progress': 'ì§„í–‰ì¤‘',
                'needs_visit': 'ğŸš— ì¶œë™ ìš”ì²­',
                'completed': 'ì™„ë£Œ',
                'confirmed': 'í™•ì¸ë¨'
            }[request.status] || request.status;

            card.innerHTML = `
                <div class="request-header">
                    <div>
                        <div class="request-title">${request.bay_number}ë²ˆ ë² ì´ - ${request.equipment_type}</div>
                        <div class="request-time">${timeAgo}</div>
                    </div>
                    <div class="request-badges">
                        <span class="badge badge-status">${statusText}</span>
                        ${request.priority !== 'normal' ? `<span class="badge badge-urgent">${request.priority === 'urgent' ? 'ê¸´ê¸‰' : 'ë†’ìŒ'}</span>` : ''}
                    </div>
                </div>

                <div class="request-info">
                    <div class="info-item">
                        <span class="info-icon">ğŸ‘¤</span>
                        <div>
                            <div class="info-label">ê³ ê°</div>
                            <div class="info-value">${request.customer_name}</div>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">ğŸ“</span>
                        <div>
                            <div class="info-label">ì „í™”ë²ˆí˜¸</div>
                            <div class="info-value">
                                <a href="tel:${request.customer_phone}" style="color: #2c3e50; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 5px;">
                                    ${request.customer_phone}
                                    <span style="font-size: 1.2rem; color: #27ae60;">ğŸ“±</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">âš ï¸</span>
                        <div>
                            <div class="info-label">ë¬¸ì œ</div>
                            <div class="info-value">${request.problem_type}</div>
                        </div>
                    </div>
                </div>

                ${request.diagnosis_result ? `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 0.9rem;">
                        <strong>AI ì§„ë‹¨:</strong> ${request.diagnosis_result}
                    </div>
                ` : ''}

                <div class="request-actions">
                    ${request.status === 'pending' ? `
                        <button class="btn btn-primary" onclick="acceptRequest('${request.id}')">
                            âœ… ë°°ì • ë°›ê¸°
                        </button>
                        <button class="btn btn-primary" onclick="openChat('${request.id}')" style="background: #667eea;">
                            ğŸ’¬ ì±„íŒ… í™•ì¸
                        </button>
                    ` : ''}
                    ${request.status === 'needs_visit' ? `
                        <button class="btn btn-danger" onclick="proposeVisitSchedule('${request.id}')" style="background: linear-gradient(135deg, #e74c3c, #c0392b); flex: 2;">
                            ğŸ“… ì¶œë™ ì‹œê°„ ì œì•ˆ
                        </button>
                        <button class="btn btn-primary" onclick="openChat('${request.id}')">
                            ğŸ’¬ ì±„íŒ…
                        </button>
                    ` : ''}
                    ${request.status === 'assigned' || request.status === 'in_progress' ? `
                        <button class="btn btn-primary" onclick="openChat('${request.id}')">
                            ğŸ’¬ ì±„íŒ…
                        </button>
                        ${request.status === 'assigned' ? `
                            <button class="btn btn-success" onclick="startWork('${request.id}')">
                                ğŸ”§ ì‘ì—… ì‹œì‘
                            </button>
                        ` : ''}
                        ${request.status === 'in_progress' ? `
                            <button class="btn btn-success" onclick="completeWork('${request.id}')">
                                âœ… ìˆ˜ë¦¬ ì™„ë£Œ
                            </button>
                        ` : ''}
                    ` : ''}
                    <button class="btn btn-secondary" onclick="viewDetails('${request.id}')">
                        ìƒì„¸ë³´ê¸°
                    </button>
                </div>
            `;

            return card;
        }

        // ìƒíƒœ ë³€ê²½ í•¨ìˆ˜ë“¤
        async function acceptRequest(requestId) {
            await updateRequestStatus(requestId, 'assigned');
            playNotificationSound();

            // ë°°ì • í›„ ìë™ìœ¼ë¡œ ì±„íŒ…ë°© ì—´ê¸°
            setTimeout(() => {
                openChat(requestId);
            }, 500);
        }

        async function startWork(requestId) {
            await updateRequestStatus(requestId, 'in_progress');
        }

        async function completeWork(requestId) {
            if (!confirm('ìˆ˜ë¦¬ë¥¼ ì™„ë£Œí•˜ì…¨ë‚˜ìš”?')) return;
            await updateRequestStatus(requestId, 'completed');
            playNotificationSound();
        }

        // ì¶œë™ ìŠ¤ì¼€ì¤„ ì œì•ˆ
        let currentScheduleRequestId = null;

        function proposeVisitSchedule(requestId) {
            currentScheduleRequestId = requestId;

            // ë‚´ì¼ ë‚ ì§œ ê¸°ë³¸ê°’
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            document.getElementById('scheduleDate').value = dateStr;

            // ì˜¤ì „ 9ì‹œ ê¸°ë³¸ê°’
            document.getElementById('scheduleTime').value = '09:00';
            document.getElementById('scheduleNotes').value = '';

            // ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('scheduleModal').classList.add('active');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
            currentScheduleRequestId = null;
        }

        async function submitVisitSchedule() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const notes = document.getElementById('scheduleNotes').value;

            if (!date || !time) {
                alert('ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                // ìŠ¤ì¼€ì¤„ ì œì•ˆ ìƒì„±
                const response = await fetch(`${API_URL}/visit-schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_id: currentScheduleRequestId,
                        proposed_by: 'technician',
                        proposed_date: date,
                        proposed_time: time,
                        notes: notes || null
                    })
                });

                const schedule = await response.json();

                // ì±„íŒ…ì— ìŠ¤ì¼€ì¤„ ë©”ì‹œì§€ ìë™ ì „ì†¡
                const dateObj = new Date(date + 'T' + time);
                const dateStr = dateObj.toLocaleDateString('ko-KR', {
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });
                const timeStr = dateObj.toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                await fetch(`${API_URL}/chat-messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_id: currentScheduleRequestId,
                        sender_type: 'technician',
                        sender_name: technicianName,
                        message_type: 'text',
                        content: `ğŸ“… ì¶œë™ ì‹œê°„ ì œì•ˆë“œë¦½ë‹ˆë‹¤\n\në‚ ì§œ: ${dateStr}\nì‹œê°„: ${timeStr}\n\n${notes ? 'ë©”ëª¨: ' + notes : 'ìœ„ ì‹œê°„ì— ë°©ë¬¸ ê°€ëŠ¥í•˜ì‹œë©´ ìˆ˜ë½ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!'}`
                    })
                });

                closeScheduleModal();
                alert('ì¶œë™ ì‹œê°„ ì œì•ˆì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadRequests();

            } catch (error) {
                console.error('ìŠ¤ì¼€ì¤„ ì œì•ˆ ì‹¤íŒ¨:', error);
                alert('ìŠ¤ì¼€ì¤„ ì œì•ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function updateRequestStatus(requestId, status) {
            try {
                await fetch(`${API_URL}/as-requests/${requestId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, assigned_technician: technicianName })
                });
                loadRequests();
            } catch (error) {
                console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ì±„íŒ… ì—´ê¸°
        async function openChat(requestId) {
            const request = requests.find(r => r.id === requestId);
            if (!request) return;

            currentChatRequest = request;

            document.getElementById('chatCustomerName').textContent = request.customer_name;
            document.getElementById('chatRequestInfo').textContent = `${request.bay_number}ë²ˆ ë² ì´ - ${request.equipment_type}`;

            // ì±„íŒ… ë©”ì‹œì§€ ë¡œë“œ
            const response = await fetch(`${API_URL}/as-requests/${requestId}/messages`);
            const messages = await response.json();

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            messages.forEach(msg => {
                displayChatMessage(msg);
            });

            // WebSocket ì—°ê²°
            if (chatWs) chatWs.close();
            chatWs = new WebSocket(`${WS_URL}/${requestId}`);
            chatWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'new_message') {
                    displayChatMessage(data.data);
                }
            };

            document.getElementById('chatSection').classList.add('active');
        }

        function displayChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.sender_type}`;

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';

            if (message.message_type === 'image' && message.file_url) {
                const img = document.createElement('img');
                img.src = `http://localhost:53001${message.file_url}`;
                img.style.maxWidth = '100%';
                img.style.borderRadius = '10px';
                img.style.cursor = 'pointer';
                img.onclick = () => window.open(img.src, '_blank');
                bubble.appendChild(img);
            }

            if (message.content) {
                const text = document.createElement('div');
                text.textContent = message.content;
                bubble.appendChild(text);
            }

            const time = document.createElement('div');
            time.style.fontSize = '0.7rem';
            time.style.opacity = '0.7';
            time.style.marginTop = '5px';
            time.textContent = new Date(message.created_at).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            bubble.appendChild(time);

            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendTechMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message && !selectedTechFile) return;

            let fileUrl = null;

            if (selectedTechFile) {
                const formData = new FormData();
                formData.append('file', selectedTechFile);
                formData.append('request_id', currentChatRequest.id);
                formData.append('uploaded_by', technicianName);

                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                fileUrl = data.file_url;
            }

            await fetch(`${API_URL}/chat-messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    request_id: currentChatRequest.id,
                    sender_type: 'technician',
                    sender_name: technicianName,
                    message_type: fileUrl ? 'image' : 'text',
                    content: message || 'ì‚¬ì§„',
                    file_url: fileUrl
                })
            });

            input.value = '';
            selectedTechFile = null;
        }

        function handleTechFileSelect(event) {
            selectedTechFile = event.target.files[0];
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendTechMessage();
            }
        }

        function closeChat() {
            const chatSection = document.getElementById('chatSection');
            if (chatSection) {
                chatSection.classList.remove('active');
            }

            if (chatWs) {
                try {
                    chatWs.close();
                    chatWs = null;
                } catch (e) {
                    console.log('WebSocket ë‹«ê¸° ì—ëŸ¬:', e);
                }
            }

            currentChatRequest = null;
            console.log('âœ… ì±„íŒ…ë°© ë‹«í˜');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function viewDetails(requestId) {
            window.open(`as-request-detail.html?id=${requestId}`, '_blank');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}ì´ˆ ì „`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}ë¶„ ì „`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}ì‹œê°„ ì „`;
            return date.toLocaleDateString('ko-KR');
        }

        function playNotificationSound() {
            // ì‹¤ì œë¡œëŠ” audio íŒŒì¼ ì¬ìƒ
            console.log('ğŸ”” ì•Œë¦¼ìŒ');
        }

        // ìƒˆ ìš”ì²­ ì•Œë¦¼ (WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ìˆ˜ì‹ )
        function showNewRequestNotification(request) {
            const notification = document.createElement('div');
            notification.className = 'new-request-notification';
            notification.innerHTML = `
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">ğŸš¨ ìƒˆë¡œìš´ AS ìš”ì²­</div>
                <div>${request.bay_number}ë²ˆ ë² ì´ - ${request.equipment_type}</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">${request.customer_name}</div>
            `;
            notification.style.cursor = 'pointer';
            notification.onclick = () => {
                openChat(request.id);
                notification.remove();
            };
            document.body.appendChild(notification);

            playNotificationSound();

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // ê¸´ê¸‰ ì¶œë™ ìš”ì²­ ì•Œë¦¼ (íŠ¹ë³„í•œ ìŠ¤íƒ€ì¼ë¡œ ê°•ì¡°)
        function showUrgentVisitNotification(request) {
            const notification = document.createElement('div');
            notification.className = 'new-request-notification';
            notification.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            notification.style.animation = 'slideIn 0.5s, pulse 1s infinite';
            notification.innerHTML = `
                <div style="font-size: 1.4rem; font-weight: bold; margin-bottom: 8px;">ğŸš—ğŸš¨ ê¸´ê¸‰ ì¶œë™ ìš”ì²­!</div>
                <div style="font-size: 1.1rem; margin-bottom: 5px;">${request.bay_number}ë²ˆ ë² ì´ - ${request.equipment_type}</div>
                <div style="font-size: 0.95rem; margin-bottom: 10px;">${request.customer_name} / ${request.customer_phone}</div>
                <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 5px; font-size: 0.9rem;">
                    í´ë¦­í•˜ì—¬ ì¶œë™ ì‹œê°„ì„ ì œì•ˆí•˜ì„¸ìš”
                </div>
            `;
            notification.style.cursor = 'pointer';
            notification.onclick = () => {
                // ìŠ¤ì¼€ì¤„ ì œì•ˆ ëª¨ë‹¬ ë°”ë¡œ ì—´ê¸°
                proposeVisitSchedule(request.id);
                notification.remove();
            };
            document.body.appendChild(notification);

            playNotificationSound();
            playNotificationSound(); // ê¸´ê¸‰ì€ 2ë²ˆ ìš¸ë¦¼

            setTimeout(() => {
                notification.remove();
            }, 8000); // ê¸´ê¸‰ì€ 8ì´ˆê°„ í‘œì‹œ
        }

        // WebSocketìœ¼ë¡œ ìƒˆ ìš”ì²­ ì‹¤ì‹œê°„ ê°ì§€
        function connectGlobalWebSocket() {
            const globalWs = new WebSocket(`${WS_URL}/technician/global`);

            globalWs.onopen = () => {
                console.log('âœ… ì‹¤ì‹œê°„ ì•Œë¦¼ ì—°ê²°ë¨');
                // ì—°ê²° ìœ ì§€ë¥¼ ìœ„í•œ ping
                setInterval(() => {
                    if (globalWs.readyState === WebSocket.OPEN) {
                        globalWs.send('ping');
                    }
                }, 30000); // 30ì´ˆë§ˆë‹¤
            };

            globalWs.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'new_request') {
                        // ìƒˆ ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ
                        console.log('ğŸš¨ ìƒˆ ìš”ì²­:', data.data);
                        showNewRequestNotification(data.data);
                        loadRequests(); // ëª©ë¡ ê°±ì‹ 
                        updateStats(); // í†µê³„ ê°±ì‹ 
                        playNotificationSound(); // ì•Œë¦¼ìŒ
                    } else if (data.type === 'urgent_visit_request') {
                        // ê¸´ê¸‰ ì¶œë™ ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ
                        console.log('ğŸš—ğŸš¨ ê¸´ê¸‰ ì¶œë™ ìš”ì²­:', data.data);
                        showUrgentVisitNotification(data.data);
                        loadRequests(); // ëª©ë¡ ê°±ì‹ 
                        updateStats(); // í†µê³„ ê°±ì‹ 
                        playNotificationSound(); // ì•Œë¦¼ìŒ
                    }
                } catch (e) {
                    // ping/pong ì‘ë‹µ ë¬´ì‹œ
                    console.log('WebSocket message:', event.data);
                }
            };

            globalWs.onerror = (error) => {
                console.log('âŒ WebSocket ì—ëŸ¬, 3ì´ˆ í›„ ì¬ì—°ê²°...', error);
                setTimeout(connectGlobalWebSocket, 3000);
            };

            globalWs.onclose = () => {
                console.log('ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œ, 3ì´ˆ í›„ ì¬ì—°ê²°...');
                setTimeout(connectGlobalWebSocket, 3000);
            };
        }

        // ==================== ë¡œê·¸ ë¶„ì„ ê¸°ëŠ¥ ====================

        async function loadLogStatistics() {
            try {
                const response = await fetch(`${API_URL}/logs/statistics`);
                const stats = await response.json();

                // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
                document.getElementById('logTotalLogs').textContent = stats.total_logs.toLocaleString();
                document.getElementById('logUniqueIps').textContent = stats.unique_ips.toLocaleString();
                document.getElementById('logTodayActivities').textContent = stats.today_activities.toLocaleString();

                // TOP ê²€ìƒ‰ì–´
                const topSearchesEl = document.getElementById('logTopSearches');
                if (stats.top_searches.length === 0) {
                    topSearchesEl.innerHTML = '<div style="color: #95a5a6;">ê²€ìƒ‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                    topSearchesEl.innerHTML = stats.top_searches.map((item, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0;">
                            <div>
                                <span style="font-weight: bold; color: #3498db; margin-right: 10px;">${index + 1}.</span>
                                <span style="font-weight: 600;">${item.keyword}</span>
                            </div>
                            <span style="background: #3498db; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">${item.count}íšŒ</span>
                        </div>
                    `).join('');
                }

                // TOP IP ì£¼ì†Œ
                const topIpsEl = document.getElementById('logTopIps');
                if (stats.top_ips.length === 0) {
                    topIpsEl.innerHTML = '<div style="color: #95a5a6;">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                    topIpsEl.innerHTML = stats.top_ips.map((item, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0;">
                            <div>
                                <span style="font-weight: bold; color: #27ae60; margin-right: 10px;">${index + 1}.</span>
                                <span style="font-family: monospace; font-weight: 600; cursor: pointer; color: #2c3e50;" onclick="searchByIpDirect('${item.ip}')">${item.ip}</span>
                            </div>
                            <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">${item.count}íšŒ</span>
                        </div>
                    `).join('');
                }

                // ì•¡ì…˜ íƒ€ì…ë³„ ë¶„í¬
                const actionCountsEl = document.getElementById('logActionCounts');
                const actionTypeNames = {
                    'page_view': 'ğŸ“„ í˜ì´ì§€ ì¡°íšŒ',
                    'search': 'ğŸ” ê²€ìƒ‰',
                    'wizard_start': 'ğŸ”¬ AI ì§„ë‹¨ ì‹œì‘',
                    'symptom_select': 'âš ï¸ ì¦ìƒ ì„ íƒ',
                    'wizard_complete': 'âœ… ì§„ë‹¨ ì™„ë£Œ',
                    'manual_view': 'ğŸ“– ë§¤ë‰´ì–¼ ì¡°íšŒ',
                    'as_request_created': 'ğŸš¨ AS ìš”ì²­',
                    'chat_start': 'ğŸ’¬ ì±„íŒ… ì‹œì‘',
                    'chat_send': 'ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€',
                    'phone_call': 'ğŸ“ ì „í™” ì—°ê²°',
                    'button_click': 'ğŸ–±ï¸ ë²„íŠ¼ í´ë¦­',
                    'file_upload': 'ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ',
                    'page_leave': 'ğŸ‘‹ í˜ì´ì§€ ì´íƒˆ',
                    'error': 'âŒ ì—ëŸ¬'
                };

                if (Object.keys(stats.action_counts).length === 0) {
                    actionCountsEl.innerHTML = '<div style="color: #95a5a6;">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                    const sortedActions = Object.entries(stats.action_counts).sort((a, b) => b[1] - a[1]);
                    actionCountsEl.innerHTML = sortedActions.map(([action, count]) => {
                        const percentage = Math.round((count / stats.total_logs) * 100);
                        return `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>${actionTypeNames[action] || action}</span>
                                    <span style="font-weight: bold;">${count}íšŒ (${percentage}%)</span>
                                </div>
                                <div style="background: #f0f0f0; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div style="background: #3498db; height: 100%; width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // ì‹œê°„ëŒ€ë³„ í™œë™
                const hourlyEl = document.getElementById('logHourlyActivity');
                if (stats.hourly_activity.length === 0) {
                    hourlyEl.innerHTML = '<div style="color: #95a5a6;">ìµœê·¼ 24ì‹œê°„ í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                    const maxCount = Math.max(...stats.hourly_activity.map(h => h.count));
                    hourlyEl.innerHTML = stats.hourly_activity.map(item => {
                        const percentage = maxCount > 0 ? Math.round((item.count / maxCount) * 100) : 0;
                        return `
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>${item.hour}ì‹œ</span>
                                    <span style="font-weight: bold;">${item.count}íšŒ</span>
                                </div>
                                <div style="background: #f0f0f0; border-radius: 10px; height: 6px; overflow: hidden;">
                                    <div style="background: #f39c12; height: 100%; width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error('ë¡œê·¸ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function searchByIp() {
            const ip = document.getElementById('ipSearchInput').value.trim();
            if (!ip) {
                alert('IP ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            searchByIpDirect(ip);
        }

        async function searchByIpDirect(ip) {
            // IP ê²€ìƒ‰ ì¸í’‹ì— ê°’ ì„¤ì •
            document.getElementById('ipSearchInput').value = ip;

            const resultsEl = document.getElementById('ipSearchResults');
            resultsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #95a5a6;">ë¡œë”© ì¤‘...</div>';

            try {
                const response = await fetch(`${API_URL}/logs/ip/${encodeURIComponent(ip)}`);
                const data = await response.json();

                if (data.logs.length === 0) {
                    resultsEl.innerHTML = '<div style="color: #95a5a6;">í•´ë‹¹ IPì˜ í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }

                const actionTypeNames = {
                    'page_view': 'ğŸ“„ í˜ì´ì§€ ì¡°íšŒ',
                    'search': 'ğŸ” ê²€ìƒ‰',
                    'wizard_start': 'ğŸ”¬ AI ì§„ë‹¨ ì‹œì‘',
                    'symptom_select': 'âš ï¸ ì¦ìƒ ì„ íƒ',
                    'wizard_complete': 'âœ… ì§„ë‹¨ ì™„ë£Œ',
                    'manual_view': 'ğŸ“– ë§¤ë‰´ì–¼ ì¡°íšŒ',
                    'as_request_created': 'ğŸš¨ AS ìš”ì²­',
                    'chat_start': 'ğŸ’¬ ì±„íŒ… ì‹œì‘',
                    'chat_send': 'ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€',
                    'phone_call': 'ğŸ“ ì „í™” ì—°ê²°',
                    'button_click': 'ğŸ–±ï¸ ë²„íŠ¼ í´ë¦­',
                    'file_upload': 'ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ',
                    'page_leave': 'ğŸ‘‹ í˜ì´ì§€ ì´íƒˆ',
                    'error': 'âŒ ì—ëŸ¬'
                };

                resultsEl.innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: #2c3e50;">ğŸ“Š IP í†µê³„: ${ip}</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">ì´ í™œë™</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">${data.statistics.total}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">ì•¡ì…˜ íƒ€ì…</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">${data.statistics.unique_actions}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">ìµœì´ˆ ë°©ë¬¸</div>
                                <div style="font-size: 0.9rem; font-weight: bold; color: #f39c12;">${new Date(data.statistics.first_seen).toLocaleString('ko-KR')}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">ìµœê·¼ í™œë™</div>
                                <div style="font-size: 0.9rem; font-weight: bold; color: #e74c3c;">${new Date(data.statistics.last_seen).toLocaleString('ko-KR')}</div>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin-bottom: 10px; color: #2c3e50;">ğŸ“‹ í™œë™ ë¡œê·¸ (ìµœê·¼ 50ê°œ)</h4>
                    <div style="max-height: 600px; overflow-y: auto;">
                        ${data.logs.map(log => {
                            const actionName = actionTypeNames[log.action_type] || log.action_type;
                            let detailHtml = '';

                            if (log.search_keyword) {
                                detailHtml = `<div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 3px;">ê²€ìƒ‰: "${log.search_keyword}"</div>`;
                            } else if (log.action_detail) {
                                try {
                                    const detail = JSON.parse(log.action_detail);
                                    const detailText = Object.entries(detail).map(([k, v]) => `${k}: ${v}`).join(', ');
                                    detailHtml = `<div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 3px;">${detailText}</div>`;
                                } catch(e) {
                                    detailHtml = `<div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 3px;">${log.action_detail}</div>`;
                                }
                            }

                            return `
                                <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 5px; border-radius: 5px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600;">${actionName}</div>
                                            ${detailHtml}
                                            ${log.page_url ? `<div style="font-size: 0.8rem; color: #95a5a6; margin-top: 3px;">ğŸ“„ ${log.page_url}</div>` : ''}
                                        </div>
                                        <div style="font-size: 0.8rem; color: #95a5a6; text-align: right; white-space: nowrap; margin-left: 10px;">
                                            ${new Date(log.created_at).toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('IP ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                resultsEl.innerHTML = '<div style="color: #e74c3c;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // ì´ˆê¸°í™”
        loadRequests();
        setInterval(loadRequests, 30000); // 30ì´ˆë§ˆë‹¤ ê°±ì‹  (ì‹¤ì‹œê°„ ì•Œë¦¼ì´ ìˆìœ¼ë¯€ë¡œ ê°„ê²© ëŠ˜ë¦¼)
        setInterval(updateStats, 30000);

        // ì‹¤ì‹œê°„ ì•Œë¦¼ì„ ìœ„í•œ WebSocket ì—°ê²°
        connectGlobalWebSocket();

        // ==================== ë¡œê·¸ ê´€ë¦¬ ====================

        let logAutoRefreshInterval = null;

        // ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadLogs() {
            const lines = document.getElementById('logLinesSelect').value;

            try {
                const response = await fetch(`${API_URL}/logs/realtime?lines=${lines}`);
                const data = await response.json();

                displayLogs(data.logs);
                document.getElementById('logCount').textContent = `${data.total}ì¤„`;
            } catch (error) {
                console.error('ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('logOutput').textContent = 'ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        // ë¡œê·¸ ê²€ìƒ‰
        async function searchLogs() {
            const keyword = document.getElementById('logSearchInput').value.trim();
            if (!keyword) {
                loadLogs();
                return;
            }

            const lines = document.getElementById('logLinesSelect').value;

            try {
                const response = await fetch(`${API_URL}/logs/search?keyword=${encodeURIComponent(keyword)}&lines=${lines}`);
                const data = await response.json();

                displayLogs(data.logs);
                document.getElementById('logCount').textContent = `${data.total}ê±´ (ê²€ìƒ‰: "${keyword}")`;
            } catch (error) {
                console.error('ë¡œê·¸ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                document.getElementById('logOutput').textContent = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }

        // ê²€ìƒ‰ ì´ˆê¸°í™”
        function clearSearch() {
            document.getElementById('logSearchInput').value = '';
            loadLogs();
        }

        // ë¡œê·¸ í‘œì‹œ
        function displayLogs(logs) {
            const output = document.getElementById('logOutput');

            if (logs.length === 0) {
                output.innerHTML = '<div style="color: #95a5a6; text-align: center; padding: 40px;">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ë¡œê·¸ íŒŒì‹± ë° í¬ë§·íŒ…
            const formattedLogs = logs.map(line => {
                // ë¡œê·¸ íŒŒì‹±: ì‹œê°„ | ë ˆë²¨ | ë‚´ìš©
                const match = line.match(/^([\d-]+ [\d:]+) \| (\w+) \| (.+)$/);

                if (!match) {
                    return `<div style="padding: 10px; margin-bottom: 5px; background: rgba(255,255,255,0.05); border-radius: 5px; color: #d4d4d4;">${escapeHtml(line)}</div>`;
                }

                const [, timestamp, level, content] = match;

                // ë ˆë²¨ë³„ ìƒ‰ìƒ
                let levelColor = '#5dade2';
                let levelIcon = 'â„¹ï¸';
                let bgColor = 'rgba(93, 173, 226, 0.1)';

                if (level === 'ERROR') {
                    levelColor = '#e74c3c';
                    levelIcon = 'âŒ';
                    bgColor = 'rgba(231, 76, 60, 0.1)';
                } else if (level === 'WARNING') {
                    levelColor = '#f39c12';
                    levelIcon = 'âš ï¸';
                    bgColor = 'rgba(243, 156, 18, 0.1)';
                } else if (content.includes('AS ìš”ì²­ ìƒì„±')) {
                    levelIcon = 'ğŸ“‹';
                    levelColor = '#2ecc71';
                    bgColor = 'rgba(46, 204, 113, 0.1)';
                } else if (content.includes('ì±„íŒ… ë©”ì‹œì§€')) {
                    levelIcon = 'ğŸ’¬';
                    levelColor = '#3498db';
                    bgColor = 'rgba(52, 152, 219, 0.1)';
                } else if (content.includes('íŒŒì¼ ì—…ë¡œë“œ')) {
                    levelIcon = 'ğŸ“';
                    levelColor = '#9b59b6';
                    bgColor = 'rgba(155, 89, 182, 0.1)';
                } else if (content.includes('ì¶œë™ ìŠ¤ì¼€ì¤„')) {
                    levelIcon = 'ğŸ“…';
                    levelColor = '#1abc9c';
                    bgColor = 'rgba(26, 188, 156, 0.1)';
                }

                // ë‚´ìš© íŒŒì‹± (ID, IP, ê³ ê° ë“±)
                const parts = content.split(' | ').map(p => p.trim());
                let formattedContent = '';

                parts.forEach((part, index) => {
                    if (index === 0) {
                        // ì²« ë²ˆì§¸ëŠ” ì´ë²¤íŠ¸ íƒ€ì…
                        formattedContent += `<div style="font-weight: bold; color: ${levelColor}; margin-bottom: 8px; font-size: 1.05em;">${levelIcon} ${escapeHtml(part)}</div>`;
                    } else {
                        // ë‚˜ë¨¸ì§€ëŠ” íƒœê·¸ë¡œ í‘œì‹œ
                        const [key, ...valueParts] = part.split(':');
                        const value = valueParts.join(':').trim();

                        let tagColor = '#546e7a';
                        if (key.includes('IP')) tagColor = '#7e57c2';
                        else if (key.includes('ê³ ê°')) tagColor = '#26a69a';
                        else if (key.includes('ë² ì´')) tagColor = '#ff7043';
                        else if (key.includes('ID')) tagColor = '#42a5f5';

                        formattedContent += `
                            <span style="display: inline-block; margin-right: 8px; margin-bottom: 5px; padding: 4px 8px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 0.9em;">
                                <span style="color: ${tagColor}; font-weight: 600;">${escapeHtml(key)}:</span>
                                <span style="color: #ecf0f1; margin-left: 4px;">${escapeHtml(value)}</span>
                            </span>
                        `;
                    }
                });

                return `
                    <div style="padding: 12px 15px; margin-bottom: 8px; background: ${bgColor}; border-left: 4px solid ${levelColor}; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                ${formattedContent}
                            </div>
                            <div style="color: #95a5a6; font-size: 0.85em; white-space: nowrap; margin-left: 15px;">
                                ğŸ• ${escapeHtml(timestamp)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            output.innerHTML = formattedLogs;

            // ìë™ ìŠ¤í¬ë¡¤ (ë§¨ ì•„ë˜ë¡œ)
            output.parentElement.scrollTop = output.parentElement.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ í† ê¸€
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshCheckbox');

            if (checkbox.checked) {
                // 5ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
                logAutoRefreshInterval = setInterval(() => {
                    loadLogs();
                }, 5000);
            } else {
                // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
                if (logAutoRefreshInterval) {
                    clearInterval(logAutoRefreshInterval);
                    logAutoRefreshInterval = null;
                }
            }
        }

        // ë¡œê·¸ íƒ­ í™œì„±í™”ì‹œ ë¡œê·¸ ë¡œë“œ
        const originalSwitchTab = switchTab;
        window.switchTab = function(tab) {
            originalSwitchTab.call(this, tab);
            if (tab === 'logs') {
                loadLogs();
                // ìë™ ìƒˆë¡œê³ ì¹¨ í™œì„±í™”
                if (document.getElementById('autoRefreshCheckbox').checked && !logAutoRefreshInterval) {
                    toggleAutoRefresh();
                }
            } else {
                // ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì´ë™ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
                if (logAutoRefreshInterval) {
                    clearInterval(logAutoRefreshInterval);
                    logAutoRefreshInterval = null;
                }
            }
        };
    </script>
</body>
</html>
